<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Kinochrome - –í–∞—à –±–∏–ª–µ—Ç –≤ –º–∏—Ä –∫–∏–Ω–æ</title>
    <meta name="csrf-token" content="{{ csrf_token }}">
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    
    <script>
        /* eslint-disable */
        window.USER_IS_AUTH = JSON.parse("{{ user.is_authenticated|yesno:'true,false'|escapejs }}");
        window.USER_NAME = "{{ user.username|default:''|escapejs }}";

        function getCsrfToken() {
            const meta = document.querySelector('meta[name="csrf-token"]');
            if (meta && meta.content) return meta.content;
            const name = 'csrftoken';
            const cookies = document.cookie ? document.cookie.split('; ') : [];
            for (let cookie of cookies) {
                if (cookie.startsWith(name + '=')) {
                    return decodeURIComponent(cookie.slice(name.length + 1));
                }
            }
            return '';
        }
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: { sans: ['Inter', 'sans-serif'] },
                    colors: {
                        brand: {
                            DEFAULT: '#FF9500', // –û—Ä–∞–Ω–∂–µ–≤—ã–π
                            hover: '#E68600',
                            light: '#FFF9F0',
                            bg: '#F9FAFB'
                        },
                        dark: {
                            DEFAULT: '#111827',
                            footer: '#1A1A1A'
                        }
                    }
                }
            }
        }
    </script>
    <style>
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
        .fade-in { animation: fadeIn 0.3s ease-in-out; }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
    </style>
</head>
<body class="bg-gray-50 text-gray-800 flex flex-col min-h-screen">

    <header class="bg-white border-b border-gray-100 sticky top-0 z-50">
        <div class="container mx-auto px-6 h-20 flex items-center justify-between">
            <div onclick="router('home')" class="cursor-pointer text-2xl font-semibold text-brand tracking-tight">
                Kinochrome
            </div>

            <nav class="hidden md:flex space-x-8 text-sm font-medium text-gray-500">
                <a href="#" onclick="router('home')" class="hover:text-brand transition">–í–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏</a>
                <a href="#" onclick="router('films')" class="hover:text-brand transition">–§–∏–ª—å–º—ã</a>
                <a href="#" onclick="router('schedule')" class="hover:text-brand transition">–†–∞—Å–ø–∏—Å–∞–Ω–∏–µ</a>
            </nav>

            <div class="flex items-center space-x-4">
                <div id="current-time" class="hidden md:block text-sm text-gray-500 font-medium"></div>
                <button id="nav-profile-btn" onclick="handleProfileNav()" class="hidden md:block text-sm font-medium text-gray-700 hover:text-brand transition">
                    {% if user.is_authenticated %}{{ user.username|default:'–ü—Ä–æ—Ñ–∏–ª—å' }}{% else %}–ü—Ä–æ—Ñ–∏–ª—å{% endif %}
                </button>
                {% if user.is_authenticated %}
                <a href="{% url 'logout' %}" class="bg-brand text-white px-5 py-2 rounded-full text-sm font-medium hover:bg-brand-dark transition shadow-lg shadow-orange-200">
                    –í—ã–π—Ç–∏
                </a>
                {% else %}
                <a href="{% url 'login' %}" class="bg-brand text-white px-5 py-2 rounded-full text-sm font-medium hover:bg-brand-dark transition shadow-lg shadow-orange-200">
                    –í–æ–π—Ç–∏
                </a>
                <a href="{% url 'register' %}" class="hidden md:block text-sm font-medium text-gray-500 hover:text-brand">
                    –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è
                </a>
                {% endif %}
            </div>
        </div>
    </header>

    <main id="app" class="flex-grow">
        </main>

    <footer class="bg-dark-footer text-gray-400 py-12 mt-auto">
        <div class="container mx-auto px-6">
            <div class="grid grid-cols-1 md:grid-cols-4 gap-8 border-b border-gray-800 pb-12">
                <div>
                    <h3 class="text-brand text-xl font-semibold mb-4">Kinochrome</h3>
                    <p class="text-sm leading-relaxed">–°–æ–≤—Ä–µ–º–µ–Ω–Ω—ã–π –∫–∏–Ω–æ—Ç–µ–∞—Ç—Ä —Å –ª—É—á—à–∏–º–∏ —Ñ–∏–ª—å–º–∞–º–∏ –∏ –ø—Ä–µ–º–∏–∞–ª—å–Ω—ã–º –∫–∞—á–µ—Å—Ç–≤–æ–º.</p>
                </div>
                <div>
                    <h4 class="text-white font-medium mb-4">–ù–∞–≤–∏–≥–∞—Ü–∏—è</h4>
                    <ul class="space-y-2 text-sm">
                        <li><a href="#" onclick="router('home')" class="hover:text-brand">–í–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏</a></li>
                        <li><a href="#" onclick="router('films')" class="hover:text-brand">–§–∏–ª—å–º—ã</a></li>
                        <li><a href="#" onclick="router('schedule')" class="hover:text-brand">–†–∞—Å–ø–∏—Å–∞–Ω–∏–µ</a></li>
                    </ul>
                </div>
                <div>
                    <h4 class="text-white font-medium mb-4">–ö–æ–º–ø–∞–Ω–∏—è</h4>
                    <ul class="space-y-2 text-sm">
                        <li><a href="#" class="hover:text-brand">–û –Ω–∞—Å</a></li>
                        <li><a href="#" onclick="router('help')" class="hover:text-brand">–ö–æ–Ω—Ç–∞–∫—Ç—ã</a></li>
                    </ul>
                </div>
                <div>
                    <h4 class="text-white font-medium mb-4">–ü–æ–¥–¥–µ—Ä–∂–∫–∞</h4>
                    <ul class="space-y-2 text-sm">
                        <li><a href="#" onclick="router('help')" class="hover:text-brand">–ü–æ–º–æ—â—å</a></li>
                        <li><a href="#" onclick="router('faq')" class="hover:text-brand">FAQ</a></li>
                    </ul>
                </div>
            </div>
            <div class="pt-8 text-center text-xs text-gray-600">
                &copy; 2024 Kinochrome. –í—Å–µ –ø—Ä–∞–≤–∞ –∑–∞—â–∏—â–µ–Ω—ã.
            </div>
        </div>
    </footer>

    <script>
        function updateAuthUI(isAuth, username) {
            const navBtn = document.getElementById('nav-profile-btn');
            if (navBtn) {
                navBtn.textContent = isAuth ? (username || '–ü—Ä–æ—Ñ–∏–ª—å') : '–ü—Ä–æ—Ñ–∏–ª—å';
            }
            window.USER_IS_AUTH = isAuth;
            window.USER_NAME = username || '';
        }

        function handleProfileNav() {
            if (!window.USER_IS_AUTH) {
                window.location.href = "{% url 'login' %}?next={% url 'spa' %}";
            } else {
                router('profile');
            }
        }

        async function loadProfile() {
    try {
        const resp = await fetch('/api/user/', { credentials: 'same-origin' });
        
        // --- 1. –ï—Å–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω ---
        if (!resp.ok) {
            updateAuthUI(false, '');
            document.getElementById('profile-name').innerText = "–ì–æ—Å—Ç—å";
            document.getElementById('profile-email').innerText = "";
            document.getElementById('profile-tickets').innerHTML = `
                <div class="text-gray-500">
                    –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤–æ–π–¥–∏—Ç–µ —á—Ç–æ–±—ã —É–≤–∏–¥–µ—Ç—å —Å–≤–æ–∏ –±–∏–ª–µ—Ç—ã.
                </div>`;
            return;
        }

        // --- 2. –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω ---
        const data = await resp.json();
        updateAuthUI(true, data.username);

        const fullName = `${data.first_name || ""} ${data.last_name || ""}`.trim();

        const nameEl = document.getElementById('profile-name');
        nameEl.innerText = fullName || data.username;

        document.getElementById('profile-email').innerText =
            data.email || "";

        // –†–æ–ª—å
        const roleEl = document.getElementById('profile-role');
        if (data.is_staff) {
            roleEl.classList.remove('hidden');
            roleEl.innerText = '–ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä';
            nameEl.classList.add('text-brand');
        } else {
            roleEl.classList.add('hidden');
            roleEl.innerText = '';
            nameEl.classList.remove('text-brand');
        }

        const initials = (fullName || data.username || '??')
            .split(' ')
            .filter(Boolean)
            .map(w => w[0])
            .join('')
            .slice(0,2)
            .toUpperCase();
        const avatar = document.getElementById('profile-avatar');
        if (avatar) avatar.innerText = initials || '–ü';

        // --- 3. –ë–∏–ª–µ—Ç—ã ---
        const wrap = document.getElementById('profile-tickets');
        const tickets = data.bookings;

        if (!tickets.length) {
            wrap.innerHTML = `<div class="text-gray-500">–ü–æ–∫–∞ –Ω–µ—Ç –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–π.</div>`;
            return;
        }

        wrap.innerHTML = tickets
            .map(
                t => `
            <div class="bg-gradient-to-br from-white to-[#fff7ec] rounded-2xl border border-orange-100 p-5 shadow-sm flex flex-col md:flex-row md:items-center md:justify-between gap-4">
                <div class="flex-1">
                    <div class="font-semibold text-lg text-gray-900">${t.movie}</div>
                    <div class="grid grid-cols-2 md:grid-cols-4 gap-3 text-sm mt-3 text-gray-700">
                        <div><p class="text-gray-400 text-xs uppercase tracking-wide">–î–∞—Ç–∞</p><p>${t.session_time}</p></div>
                        <div><p class="text-gray-400 text-xs uppercase tracking-wide">–ö–æ–ª-–≤–æ</p><p>${t.quantity}</p></div>
                        <div><p class="text-gray-400 text-xs uppercase tracking-wide">–°—É–º–º–∞</p><p class="font-semibold">${t.total_price} ‚ÇΩ</p></div>
                    </div>
                </div>
                <div class="flex flex-col items-start gap-2">
                    <p class="text-xs text-gray-400 uppercase tracking-wide">–ö–æ–¥ –±–∏–ª–µ—Ç–∞</p>
                    <div class="bg-[#0f172a] text-white font-mono text-sm px-4 py-2 rounded-lg shadow-md">
                        ${t.qr || ('KINO-' + btoa(String(t.id)).replace(/=/g,'').slice(0,8))}
                    </div>
                </div>
            </div>
            `
            )
            .join("");
    } catch (err) {
        console.error(err);
        updateAuthUI(false, '');
    }
}

        // --- 1. –î–ê–ù–ù–´–ï --- (–≥—Ä—É–∑–∏–º —Å —Å–µ—Ä–≤–µ—Ä–∞)
        let moviesData = [];

        // –î–Ω–∏ –¥–ª—è —Ä–∞—Å–ø–∏—Å–∞–Ω–∏—è (—Ä–µ–∞–ª—å–Ω—ã–µ, –ú–°–ö)
        function getMoscowDate(offset = 0) {
            const now = new Date();
            const mskString = now.toLocaleString('en-US', { timeZone: 'Europe/Moscow' });
            const mskDate = new Date(mskString);
            mskDate.setDate(mskDate.getDate() + offset);
            return mskDate;
        }

        function formatDay(offset = 0) {
            return getMoscowDate(offset).toLocaleDateString('ru-RU', { day: 'numeric', month: 'long' });
        }

        function getNextSession(movieTimes) {
            const now = getMoscowDate(0);
            const todayStr = formatDay(0);
            for (const t of movieTimes) {
                const [h, m] = t.split(':').map(Number);
                const candidate = new Date(getMoscowDate(0));
                candidate.setHours(h, m, 0, 0);
                if (candidate > now) {
                    return { time: t, date: todayStr };
                }
            }
            // –µ—Å–ª–∏ –≤—Å–µ –≤—Ä–µ–º–µ–Ω–∞ –ø—Ä–æ—à–ª–∏, –±–µ—Ä–µ–º –ø–µ—Ä–≤–æ–µ –Ω–∞ –∑–∞–≤—Ç—Ä–∞
            return { time: movieTimes[0], date: formatDay(1) };
        }

        const scheduleDays = [
            { id: 0, label: "–°–µ–≥–æ–¥–Ω—è", date: formatDay(0) },
            { id: 1, label: "–ó–∞–≤—Ç—Ä–∞", date: formatDay(1) },
            { id: 2, label: "–ü–æ—Å–ª–µ–∑–∞–≤—Ç—Ä–∞", date: formatDay(2) },
            { id: 3, label: "–ß–µ—Ä–µ–∑ 3 –¥–Ω—è", date: formatDay(3) },
            { id: 4, label: "–ß–µ—Ä–µ–∑ 4 –¥–Ω—è", date: formatDay(4) },
        ];

        // –ì–ª–æ–±–∞–ª—å–Ω–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ
        let currentBooking = {
            movieTitle: "–ù–µ –≤—ã–±—Ä–∞–Ω",
            date: formatDay(0),
            time: "--:--",
            price: 400
        };

        async function loadMovies() {
            try {
                const resp = await fetch('/api/movies/');
                const data = await resp.json();
                moviesData = (data || []).map(m => {
                    // –ü—Ä–µ–æ–±—Ä–∞–∑—É–µ–º sessions –≤ –º–∞—Å—Å–∏–≤ –≤—Ä–µ–º–µ–Ω
                    const times = (m.sessions || []).map(s => {
                        const dt = new Date(s.start_time);
                        const mskString = dt.toLocaleString('en-US', { timeZone: 'Europe/Moscow' });
                        const mskDate = new Date(mskString);
                        const hours = String(mskDate.getHours()).padStart(2, '0');
                        const minutes = String(mskDate.getMinutes()).padStart(2, '0');
                        return `${hours}:${minutes}`;
                    });
                    
                    return {
                        id: m.id,
                        title: m.title,
                        genre: m.genre?.name || '‚Äî',
                        rating: m.rating || '‚Äî',
                        year: m.year || getMoscowDate(0).getFullYear(),
                        duration: m.duration_minutes ? `${m.duration_minutes} –º–∏–Ω` : '',
                        img: m.poster_url || '',
                        times: times
                    };
                });
            } catch (e) {
                console.error('movies load error', e);
                moviesData = [];
            }
        }

        // --- 2. –®–ê–ë–õ–û–ù–´ –°–¢–†–ê–ù–ò–¶ ---
        const pages = {
            home: `
                <section class="bg-brand relative overflow-hidden">
                    <div class="absolute inset-0 bg-gradient-to-r from-orange-500 to-orange-400"></div>
                    <div class="container mx-auto px-6 py-24 md:py-32 relative z-10 text-center text-white">
                        <h1 class="text-4xl md:text-6xl font-medium mb-6">–ì–æ—Ç–æ–≤—ã –∫ –Ω–µ–∑–∞–±—ã–≤–∞–µ–º–æ–º—É –≤–µ—á–µ—Ä—É?</h1>
                        <p class="text-lg md:text-xl opacity-90 mb-10 max-w-2xl mx-auto">–ü—Ä–∏—Å–æ–µ–¥–∏–Ω—è–π—Ç–µ—Å—å –∫ —Ç—ã—Å—è—á–∞–º –∑—Ä–∏—Ç–µ–ª–µ–π, –∫–æ—Ç–æ—Ä—ã–µ —É–∂–µ –≤—ã–±—Ä–∞–ª–∏ Kinochrome.</p>
                        <button onclick="router('schedule')" class="bg-white text-brand px-8 py-4 rounded-xl font-semibold text-lg hover:shadow-xl transition transform hover:-translate-y-1">
                            –ü–æ—Å–º–æ—Ç—Ä–µ—Ç—å —Ä–∞—Å–ø–∏—Å–∞–Ω–∏–µ
                        </button>
                    </div>
                </section>

                <section class="py-20 bg-gray-50">
                    <div class="container mx-auto px-6 text-center mb-12">
                        <h2 class="text-3xl font-semibold text-gray-900">–ü–æ—á–µ–º—É –≤—ã–±–∏—Ä–∞—é—Ç Kinochrome</h2>
                        <p class="text-gray-500 mt-2">–í—Å—ë –¥–ª—è –≤–∞—à–µ–≥–æ –∫–æ–º—Ñ–æ—Ä—Ç–∞ –∏ —É–¥–æ–≤–æ–ª—å—Å—Ç–≤–∏—è</p>
                    </div>
                    <div class="container mx-auto px-6 grid grid-cols-1 md:grid-cols-2 gap-8">
                        <div class="bg-white p-8 rounded-2xl shadow-sm hover:shadow-md transition">
                            <div class="w-12 h-12 bg-brand text-white flex items-center justify-center rounded-xl text-xl font-bold mb-6">1</div>
                            <h3 class="text-xl font-semibold mb-3">–í—ã–±–∏—Ä–∞–π—Ç–µ –ª—É—á—à–∏–µ –º–µ—Å—Ç–∞</h3>
                            <p class="text-gray-500 text-sm leading-relaxed">–ò–Ω—Ç–µ—Ä–∞–∫—Ç–∏–≤–Ω–∞—è —Å—Ö–µ–º–∞ –∑–∞–ª–∞ –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç –≤—Å–µ —Å–≤–æ–±–æ–¥–Ω—ã–µ –º–µ—Å—Ç–∞.</p>
                        </div>
                        <div class="bg-white p-8 rounded-2xl shadow-sm hover:shadow-md transition">
                            <div class="w-12 h-12 bg-brand text-white flex items-center justify-center rounded-xl text-xl font-bold mb-6">2</div>
                            <h3 class="text-xl font-semibold mb-3">–ë—Ä–æ–Ω–∏—Ä—É–π—Ç–µ –∑–∞ –º–∏–Ω—É—Ç—É</h3>
                            <p class="text-gray-500 text-sm leading-relaxed">–ü—Ä–æ—Å—Ç–æ–π –ø—Ä–æ—Ü–µ—Å—Å: –≤—ã–±—Ä–∞–ª–∏ —Ñ–∏–ª—å–º, –≤—Ä–µ–º—è, –º–µ—Å—Ç–∞ - –≥–æ—Ç–æ–≤–æ! –ë–∏–ª–µ—Ç –Ω–∞ –ø–æ—á—Ç–µ.</p>
                        </div>
                        <div class="bg-white p-8 rounded-2xl shadow-sm hover:shadow-md transition">
                            <div class="w-12 h-12 bg-brand text-white flex items-center justify-center rounded-xl text-xl font-bold mb-6">3</div>
                            <h3 class="text-xl font-semibold mb-3">–ü—Ä–µ–º–∏–∞–ª—å–Ω–æ–µ –∫–∞—á–µ—Å—Ç–≤–æ</h3>
                            <p class="text-gray-500 text-sm leading-relaxed">4K –ø—Ä–æ–µ–∫—Ü–∏—è, –∑–≤—É–∫ Dolby Atmos –∏ –∫–æ–º—Ñ–æ—Ä—Ç–Ω—ã–µ –∫—Ä–µ—Å–ª–∞ –¥–ª—è –ø–æ–ª–Ω–æ–≥–æ –ø–æ–≥—Ä—É–∂–µ–Ω–∏—è.</p>
                        </div>
                        <div class="bg-white p-8 rounded-2xl shadow-sm hover:shadow-md transition">
                            <div class="w-12 h-12 bg-brand text-white flex items-center justify-center rounded-xl text-xl font-bold mb-6">4</div>
                            <h3 class="text-xl font-semibold mb-3">–í—Å–µ–≥–¥–∞ –∞–∫—Ç—É–∞–ª—å–Ω–∞—è –∞—Ñ–∏—à–∞</h3>
                            <p class="text-gray-500 text-sm leading-relaxed">–í—Å–µ –Ω–æ–≤–∏–Ω–∫–∏ –∏ –ø—Ä–µ–º—å–µ—Ä—ã. –û–±–Ω–æ–≤–ª—è–µ–º —Ä–∞—Å–ø–∏—Å–∞–Ω–∏–µ –∫–∞–∂–¥—ã–π –¥–µ–Ω—å.</p>
                        </div>
                    </div>
                </section>
                
                <section class="py-16 bg-white">
                    <div class="container mx-auto px-6 grid grid-cols-2 md:grid-cols-4 gap-8 text-center">
                        <div><div class="text-3xl font-bold text-brand mb-2">50K+</div><div class="text-xs uppercase tracking-wide text-gray-400">–ó—Ä–∏—Ç–µ–ª–µ–π</div></div>
                        <div><div class="text-3xl font-bold text-brand mb-2">8</div><div class="text-xs uppercase tracking-wide text-gray-400">–ó–∞–ª–æ–≤ Dolby Atmos</div></div>
                        <div><div class="text-3xl font-bold text-brand mb-2">24/7</div><div class="text-xs uppercase tracking-wide text-gray-400">–û–Ω–ª–∞–π–Ω</div></div>
                        <div><div class="text-3xl font-bold text-brand mb-2">250+</div><div class="text-xs uppercase tracking-wide text-gray-400">–°–µ–∞–Ω—Å–æ–≤</div></div>
                    </div>
                </section>
            `,

            films: `
                <div class="container mx-auto px-6 py-10 fade-in">
                    <div class="flex flex-col md:flex-row justify-between items-start md:items-center mb-8">
                        <div>
                            <h2 class="text-3xl font-semibold text-gray-900">–í—Å–µ —Ñ–∏–ª—å–º—ã</h2>
                            <p class="text-gray-500 text-sm mt-1">–í—ã–±–µ—Ä–∏—Ç–µ –∂–∞–Ω—Ä –¥–ª—è —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏–∏</p>
                        </div>
                        <div class="mt-4 md:mt-0 flex space-x-2 overflow-x-auto no-scrollbar pb-2" id="genre-buttons"></div>
                    </div>
                    <div id="movies-grid" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-6"></div>
                </div>
            `,

            // –°–¢–†–ê–ù–ò–¶–ê –†–ê–°–ü–ò–°–ê–ù–ò–Ø
            schedule: `
                <div class="container mx-auto px-6 py-10 fade-in">
                    <h2 class="text-3xl font-semibold text-gray-900 mb-6">–†–∞—Å–ø–∏—Å–∞–Ω–∏–µ —Å–µ–∞–Ω—Å–æ–≤</h2>
                    
                    <div class="flex space-x-3 overflow-x-auto no-scrollbar mb-8 pb-2" id="schedule-days-container"></div>

                    <div id="schedule-list" class="space-y-6"></div>
                </div>
            `,

            // FAQ (–ù–û–í–ê–Ø)
            faq: `
                <div class="container mx-auto px-6 py-12 fade-in max-w-4xl">
                    <h2 class="text-3xl font-bold mb-2 text-center">–ß–∞—Å—Ç–æ –∑–∞–¥–∞–≤–∞–µ–º—ã–µ –≤–æ–ø—Ä–æ—Å—ã</h2>
                    <p class="text-gray-500 text-center mb-10">–û—Ç–≤–µ—Ç—ã –Ω–∞ —Å–∞–º—ã–µ –ø–æ–ø—É–ª—è—Ä–Ω—ã–µ –≤–æ–ø—Ä–æ—Å—ã –∑—Ä–∏—Ç–µ–ª–µ–π</p>
                    
                    <div class="space-y-4">
                        <div class="bg-white p-6 rounded-2xl border border-gray-100 shadow-sm">
                            <h3 class="font-semibold text-lg mb-2">–ö–∞–∫ –≤–µ—Ä–Ω—É—Ç—å –±–∏–ª–µ—Ç?</h3>
                            <p class="text-gray-600 text-sm">–í—ã –º–æ–∂–µ—Ç–µ –≤–µ—Ä–Ω—É—Ç—å –±–∏–ª–µ—Ç –Ω–µ –ø–æ–∑–¥–Ω–µ–µ, —á–µ–º –∑–∞ 30 –º–∏–Ω—É—Ç –¥–æ –Ω–∞—á–∞–ª–∞ —Å–µ–∞–Ω—Å–∞ —á–µ—Ä–µ–∑ –ª–∏—á–Ω—ã–π –∫–∞–±–∏–Ω–µ—Ç. –°—Ä–µ–¥—Å—Ç–≤–∞ –≤–µ—Ä–Ω—É—Ç—Å—è –Ω–∞ –∫–∞—Ä—Ç—É –≤ —Ç–µ—á–µ–Ω–∏–µ 3-5 –¥–Ω–µ–π.</p>
                        </div>
                        <div class="bg-white p-6 rounded-2xl border border-gray-100 shadow-sm">
                            <h3 class="font-semibold text-lg mb-2">–ù—É–∂–Ω–æ –ª–∏ —Ä–∞—Å–ø–µ—á–∞—Ç—ã–≤–∞—Ç—å —ç–ª–µ–∫—Ç—Ä–æ–Ω–Ω—ã–π –±–∏–ª–µ—Ç?</h3>
                            <p class="text-gray-600 text-sm">–ù–µ—Ç, –¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –ø–æ–∫–∞–∑–∞—Ç—å QR-–∫–æ–¥ –±–∏–ª–µ—Ç–∞ —Å —ç–∫—Ä–∞–Ω–∞ —Å–º–∞—Ä—Ç—Ñ–æ–Ω–∞ –∫–æ–Ω—Ç—Ä–æ–ª–µ—Ä—É –ø—Ä–∏ –≤—Ö–æ–¥–µ –≤ –∑–∞–ª.</p>
                        </div>
                        <div class="bg-white p-6 rounded-2xl border border-gray-100 shadow-sm">
                            <h3 class="font-semibold text-lg mb-2">–ï—Å—Ç—å –ª–∏ —Å–∫–∏–¥–∫–∏ –¥–ª—è —Å—Ç—É–¥–µ–Ω—Ç–æ–≤ –∏ –ø–µ–Ω—Å–∏–æ–Ω–µ—Ä–æ–≤?</h3>
                            <p class="text-gray-600 text-sm">–î–∞, —Å–∫–∏–¥–∫–∞ 15% –¥–µ–π—Å—Ç–≤—É–µ—Ç –Ω–∞ —Å–µ–∞–Ω—Å—ã –¥–æ 17:00 –ø–æ –±—É–¥–Ω—è–º –ø—Ä–∏ –ø—Ä–µ–¥—ä—è–≤–ª–µ–Ω–∏–∏ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É—é—â–µ–≥–æ –¥–æ–∫—É–º–µ–Ω—Ç–∞.</p>
                        </div>
                        <div class="bg-white p-6 rounded-2xl border border-gray-100 shadow-sm">
                            <h3 class="font-semibold text-lg mb-2">–ì–¥–µ –º–æ–∂–Ω–æ –ø—Ä–∏–ø–∞—Ä–∫–æ–≤–∞—Ç—å—Å—è?</h3>
                            <p class="text-gray-600 text-sm">–î–ª—è –≥–æ—Å—Ç–µ–π –∫–∏–Ω–æ—Ç–µ–∞—Ç—Ä–∞ –¥–æ—Å—Ç—É–ø–Ω–∞ –±–µ—Å–ø–ª–∞—Ç–Ω–∞—è –ø–æ–¥–∑–µ–º–Ω–∞—è –ø–∞—Ä–∫–æ–≤–∫–∞ –¢–¶ (–ø–µ—Ä–≤—ã–µ 3 —á–∞—Å–∞). –í—ä–µ–∑–¥ —Å–æ —Å—Ç–æ—Ä–æ–Ω—ã –≥–ª–∞–≤–Ω–æ–π —É–ª–∏—Ü—ã.</p>
                        </div>
                    </div>
                    <div class="mt-8 text-center">
                        <p class="text-gray-500 text-sm">–ù–µ –Ω–∞—à–ª–∏ –æ—Ç–≤–µ—Ç?</p>
                        <button onclick="router('help')" class="text-brand font-medium hover:underline mt-1">–ù–∞–ø–∏—Å–∞—Ç—å –≤ –ø–æ–¥–¥–µ—Ä–∂–∫—É</button>
                    </div>
                </div>
            `,

            // –ü–û–ú–û–©–¨ (–ù–û–í–ê–Ø)
            help: `
                <div class="container mx-auto px-6 py-12 fade-in max-w-2xl">
                    <div class="bg-white p-8 rounded-3xl shadow-xl border border-gray-100">
                        <h2 class="text-2xl font-bold mb-2">–°–ª—É–∂–±–∞ –ø–æ–¥–¥–µ—Ä–∂–∫–∏</h2>
                        <p class="text-gray-500 text-sm mb-6">–ú—ã –≤—Å–µ–≥–¥–∞ –≥–æ—Ç–æ–≤—ã –ø–æ–º–æ—á—å –≤–∞–º —Å –ª—é–±—ã–º –≤–æ–ø—Ä–æ—Å–æ–º</p>

                        <form onsubmit="event.preventDefault(); alert('–°–æ–æ–±—â–µ–Ω–∏–µ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ!'); router('home');">
                            <div class="mb-4">
                                <label class="block text-xs font-semibold text-gray-700 mb-2">–¢–µ–º–∞ –æ–±—Ä–∞—â–µ–Ω–∏—è</label>
                                <select class="w-full px-4 py-3 rounded-xl border border-gray-200 focus:outline-none focus:border-brand bg-white">
                                    <option>–ü—Ä–æ–±–ª–µ–º–∞ —Å –æ–ø–ª–∞—Ç–æ–π</option>
                                    <option>–í–æ–∑–≤—Ä–∞—Ç –±–∏–ª–µ—Ç–∞</option>
                                    <option>–ó–∞–±—ã—Ç—ã–µ –≤–µ—â–∏</option>
                                    <option>–î—Ä—É–≥–æ–µ</option>
                                </select>
                            </div>
                            <div class="mb-4">
                                <label class="block text-xs font-semibold text-gray-700 mb-2">Email –¥–ª—è —Å–≤—è–∑–∏</label>
                                <input type="email" placeholder="your@email.com" class="w-full px-4 py-3 rounded-xl border border-gray-200 focus:outline-none focus:border-brand">
                            </div>
                            <div class="mb-6">
                                <label class="block text-xs font-semibold text-gray-700 mb-2">–°–æ–æ–±—â–µ–Ω–∏–µ</label>
                                <textarea rows="4" placeholder="–û–ø–∏—à–∏—Ç–µ –≤–∞—à—É –ø—Ä–æ–±–ª–µ–º—É..." class="w-full px-4 py-3 rounded-xl border border-gray-200 focus:outline-none focus:border-brand"></textarea>
                            </div>
                            <button class="w-full bg-brand text-white py-3.5 rounded-xl font-bold hover:bg-brand-hover shadow-lg">–û—Ç–ø—Ä–∞–≤–∏—Ç—å</button>
                        </form>

                        <div class="mt-8 pt-8 border-t border-gray-100">
                            <div class="flex items-center space-x-4 mb-4">
                                <div class="w-10 h-10 bg-orange-100 rounded-full flex items-center justify-center text-brand font-bold">üìû</div>
                                <div>
                                    <p class="text-xs text-gray-400">–ì–æ—Ä—è—á–∞—è –ª–∏–Ω–∏—è</p>
                                    <p class="font-bold">8 (800) 555-35-35</p>
                                </div>
                            </div>
                            <div class="flex items-center space-x-4">
                                <div class="w-10 h-10 bg-orange-100 rounded-full flex items-center justify-center text-brand font-bold">‚úâÔ∏è</div>
                                <div>
                                    <p class="text-xs text-gray-400">Email</p>
                                    <p class="font-bold">support@kinochrome.ru</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            `,

            // –ë–†–û–ù–ò–†–û–í–ê–ù–ò–ï
            booking: `
                <div class="container mx-auto px-6 py-10 fade-in h-full">
                    <div class="flex flex-col lg:flex-row gap-8">
                        <div class="flex-grow">
                            <button onclick="router('schedule')" class="text-gray-400 text-sm mb-4 hover:text-brand">‚Üê –í–µ—Ä–Ω—É—Ç—å—Å—è –∫ —Ä–∞—Å–ø–∏—Å–∞–Ω–∏—é</button>
                            <h2 class="text-2xl font-semibold mb-6">–í—ã–±–æ—Ä –º–µ—Å—Ç: <span id="booking-movie-title" class="text-brand"></span></h2>
                            
                            <div class="flex justify-center space-x-6 mb-8 text-sm">
                                <div class="flex items-center"><div class="w-4 h-4 rounded border border-gray-200 mr-2"></div> –°–≤–æ–±–æ–¥–Ω–æ</div>
                                <div class="flex items-center"><div class="w-4 h-4 rounded bg-brand mr-2"></div> –í—ã–±—Ä–∞–Ω–æ</div>
                                <div class="flex items-center"><div class="w-4 h-4 rounded bg-gray-300 mr-2"></div> –ó–∞–Ω—è—Ç–æ</div>
                            </div>

                            <div class="mb-10 relative flex justify-center">
                                <div class="w-2/3 h-2 bg-brand rounded-full shadow-[0_4px_20px_rgba(255,149,0,0.5)]"></div>
                                <div class="absolute top-4 text-xs tracking-[0.5em] text-gray-400">–≠–ö–†–ê–ù</div>
                            </div>

                            <div class="bg-white p-8 rounded-3xl mb-8 flex flex-col gap-3 items-center shadow-sm border border-gray-100" id="seat-grid"></div>

                             <h2 class="text-xl font-semibold mb-4 mt-8">–í–∞—à–∏ –¥–∞–Ω–Ω—ã–µ</h2>
                             <div class="bg-white p-6 rounded-2xl shadow-sm border border-gray-100">
                                <div class="space-y-4">
                                    <input type="text" placeholder="–í–∞—à–µ –∏–º—è" class="w-full border border-gray-200 rounded-lg px-4 py-3 text-sm focus:outline-none focus:border-brand">
                                    <input type="email" placeholder="your@email.com" class="w-full border border-gray-200 rounded-lg px-4 py-3 text-sm focus:outline-none focus:border-brand">
                                </div>
                             </div>
                        </div>

                        <div class="w-full lg:w-96">
                            <div class="bg-white p-6 rounded-2xl shadow-lg border border-gray-100 sticky top-24">
                                <h3 class="text-lg font-semibold mb-6">–ë–∏–ª–µ—Ç</h3>
                                <div class="space-y-4 text-sm mb-6 border-b border-gray-100 pb-6">
                                    <div class="flex justify-between"><span class="text-gray-500">–§–∏–ª—å–º</span><span class="font-medium text-right w-1/2 truncate" id="summary-title">...</span></div>
                                    <div class="flex justify-between"><span class="text-gray-500">–î–∞—Ç–∞</span><span class="font-medium" id="summary-date">...</span></div>
                                    <div class="flex justify-between"><span class="text-gray-500">–í—Ä–µ–º—è</span><span class="font-medium" id="summary-time">...</span></div>
                                     <div class="flex justify-between"><span class="text-gray-500">–ú–µ—Å—Ç–∞</span><span class="font-medium" id="selected-seats-text">–ù–µ –≤—ã–±—Ä–∞–Ω—ã</span></div>
                                </div>
                                <div class="flex justify-between items-center mb-6">
                                    <span class="text-lg font-semibold">–ò—Ç–æ–≥–æ</span>
                                    <span class="text-xl font-bold text-brand" id="total-price">0 ‚ÇΩ</span>
                                </div>
                                <button id="booking-submit-btn" onclick="completeBooking()" class="w-full bg-brand text-white py-3 rounded-xl font-medium hover:bg-brand-hover transition shadow-lg shadow-orange-100 disabled:opacity-50 disabled:cursor-not-allowed">
                                    –û–ø–ª–∞—Ç–∏—Ç—å
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            `,

            profile: `
                <div class="container mx-auto px-6 py-10 fade-in">
                    <div class="bg-white rounded-2xl p-8 mb-8 border border-gray-100 flex flex-col md:flex-row md:items-center justify-between shadow-sm">
                        <div class="flex items-center mb-4 md:mb-0">
                            <div class="w-16 h-16 bg-brand rounded-full flex items-center justify-center text-white text-2xl font-bold mr-6" id="profile-avatar">–ò–ò</div>
                            <div>
                                <div class="flex items-center gap-3">
                                    <h2 class="text-2xl font-bold text-gray-900" id="profile-name">–ì–æ—Å—Ç—å</h2>
                                    <span id="profile-role" class="hidden admin-badge">–ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä</span>
                                </div>
                                <p class="text-gray-500 text-sm" id="profile-email"></p>
                            </div>
                        </div>
                        <div class="flex items-center gap-3">
                            <a href="{% url 'logout' %}" class="text-sm text-gray-500 hover:text-brand">–í—ã–π—Ç–∏</a>
                        </div>
                    </div>

                    <h3 class="text-xl font-semibold mb-4">–ú–æ–∏ –±–∏–ª–µ—Ç—ã</h3>
                    <div id="profile-tickets" class="space-y-4">
                        <div class="bg-white rounded-2xl border border-gray-100 p-6 shadow-sm text-gray-500">
                            –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤–æ–π–¥–∏—Ç–µ —á—Ç–æ–±—ã —É–≤–∏–¥–µ—Ç—å —Å–≤–æ–∏ –±–∏–ª–µ—Ç—ã.
                        </div>
                    </div>
                </div>
            `,

            login: `
                <div class="container mx-auto px-6 py-16 flex justify-center items-center fade-in">
                    <div class="bg-brand-light p-8 md:p-12 rounded-3xl w-full max-w-lg shadow-xl relative overflow-hidden">
                        <div class="absolute -top-10 -right-10 w-32 h-32 bg-orange-200 rounded-full opacity-50 blur-xl"></div>
                        <h2 class="text-3xl font-bold mb-2">–í—Ö–æ–¥</h2>
                        <form onsubmit="event.preventDefault(); router('profile');">
                            <input type="email" placeholder="Email" class="w-full mb-4 px-4 py-3 rounded-xl border border-gray-200 focus:outline-none focus:border-brand">
                            <input type="password" placeholder="–ü–∞—Ä–æ–ª—å" class="w-full mb-6 px-4 py-3 rounded-xl border border-gray-200 focus:outline-none focus:border-brand">
                            <button class="w-full bg-brand text-white py-3.5 rounded-xl font-bold text-lg hover:bg-brand-hover shadow-lg">–í–æ–π—Ç–∏</button>
                        </form>
                        <div class="mt-6 text-center text-sm text-gray-500">
                            –ù–µ—Ç –∞–∫–∫–∞—É–Ω—Ç–∞? <a href="#" onclick="router('register')" class="text-brand font-bold hover:underline">–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è</a>
                        </div>
                    </div>
                </div>
            `,

            // –†–ï–ì–ò–°–¢–†–ê–¶–ò–Ø (–û–ë–ù–û–í–õ–ï–ù–ù–ê–Ø –° –¢–ï–õ–ï–§–û–ù–û–ú)
            register: `
                <div class="container mx-auto px-6 py-10 flex justify-center items-center fade-in">
                    <div class="bg-white p-8 md:p-10 rounded-3xl w-full max-w-2xl shadow-xl border border-gray-100 relative">
                         <h2 class="text-3xl font-bold mb-2 text-center">–°–æ–∑–¥–∞—Ç—å –∞–∫–∫–∞—É–Ω—Ç</h2>
                         <p class="text-gray-500 text-sm mb-8 text-center">–ó–∞–ø–æ–ª–Ω–∏—Ç–µ –¥–∞–Ω–Ω—ã–µ –¥–ª—è —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏</p>

                         <form onsubmit="event.preventDefault(); router('profile');" class="space-y-4">
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                <div>
                                    <label class="block text-xs font-semibold text-gray-700 mb-2">–ò–º—è</label>
                                    <input type="text" placeholder="–ò–≤–∞–Ω" class="w-full px-4 py-3 rounded-xl border border-gray-200 focus:outline-none focus:border-brand transition">
                                </div>
                                <div>
                                    <label class="block text-xs font-semibold text-gray-700 mb-2">–§–∞–º–∏–ª–∏—è</label>
                                    <input type="text" placeholder="–ò–≤–∞–Ω–æ–≤" class="w-full px-4 py-3 rounded-xl border border-gray-200 focus:outline-none focus:border-brand transition">
                                </div>
                            </div>

                            <div>
                                <label class="block text-xs font-semibold text-gray-700 mb-2">Email</label>
                                <input type="email" placeholder="your@email.com" class="w-full px-4 py-3 rounded-xl border border-gray-200 focus:outline-none focus:border-brand transition">
                            </div>
                            
                            <div>
                                <label class="block text-xs font-semibold text-gray-700 mb-2">–¢–µ–ª–µ—Ñ–æ–Ω</label>
                                <input type="tel" placeholder="+7 (900) 123-45-67" class="w-full px-4 py-3 rounded-xl border border-gray-200 focus:outline-none focus:border-brand transition">
                            </div>

                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                <div>
                                    <label class="block text-xs font-semibold text-gray-700 mb-2">–ü–∞—Ä–æ–ª—å</label>
                                    <input type="password" placeholder="–ú–∏–Ω. 8 —Å–∏–º–≤–æ–ª–æ–≤" class="w-full px-4 py-3 rounded-xl border border-gray-200 focus:outline-none focus:border-brand transition">
                                </div>
                                <div>
                                    <label class="block text-xs font-semibold text-gray-700 mb-2">–ü–æ–≤—Ç–æ—Ä–∏—Ç–µ –ø–∞—Ä–æ–ª—å</label>
                                    <input type="password" placeholder="–ü–æ–≤—Ç–æ—Ä–∏—Ç–µ –ø–∞—Ä–æ–ª—å" class="w-full px-4 py-3 rounded-xl border border-gray-200 focus:outline-none focus:border-brand transition">
                                </div>
                            </div>

                            <div class="flex items-start mb-6 pt-2">
                                <input id="terms" type="checkbox" class="mt-1 mr-3 text-brand focus:ring-brand rounded border-gray-300">
                                <label for="terms" class="text-xs text-gray-500 leading-relaxed">
                                    –Ø —Å–æ–≥–ª–∞—Å–µ–Ω —Å <a href="#" class="text-brand hover:underline">–£—Å–ª–æ–≤–∏—è–º–∏</a>.
                                </label>
                            </div>

                            <button type="submit" class="w-full bg-brand text-white py-3.5 rounded-xl font-bold text-lg hover:bg-brand-hover transition shadow-lg shadow-orange-200">
                                –ó–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞—Ç—å—Å—è
                            </button>
                         </form>

                         <div class="mt-6 text-center text-sm text-gray-500">
                            –£–∂–µ –µ—Å—Ç—å –∞–∫–∫–∞—É–Ω—Ç? <a href="#" onclick="router('login')" class="text-brand font-bold hover:underline">–í–æ–π—Ç–∏</a>
                        </div>
                    </div>
                </div>
            `
        };

        // --- 3. –õ–û–ì–ò–ö–ê ---
        
        async function router(route) {
            const app = document.getElementById('app');
            if (!pages[route]) route = 'home';

            // –ü—Ä–∏ –∑–∞—Ö–æ–¥–µ –Ω–∞ —Ñ–∏–ª—å–º—ã/—Ä–∞—Å–ø–∏—Å–∞–Ω–∏–µ ‚Äî –ø–æ–¥–≥—Ä—É–∂–∞–µ–º –¥–∞–Ω–Ω—ã–µ –∏–∑ API
            if ((route === 'films' || route === 'schedule') && moviesData.length === 0) {
                await loadMovies();
            }

            app.innerHTML = pages[route];
            window.scrollTo(0, 0);

            if (route === 'booking') initBookingPage();
            if (route === 'films') initFilms('–í—Å–µ');
            if (route === 'schedule') initSchedule(0); // –ü–æ —É–º–æ–ª—á–∞–Ω–∏—é –æ—Ç–∫—Ä—ã–≤–∞–µ–º –ø–µ—Ä–≤—ã–π –¥–µ–Ω—å
            if (route === 'profile') {
                if (!window.USER_IS_AUTH) {
                    window.location.href = "{% url 'login' %}?next={% url 'spa' %}";
                    return;
                }
                loadProfile();
            }
        }

        // --- –°–¢–ê–†–¢ –ë–†–û–ù–ò–†–û–í–ê–ù–ò–Ø ---
        function startBooking(movieTitle, time, date) {
            if (!window.USER_IS_AUTH) {
                window.location.href = "{% url 'login' %}?next={% url 'spa' %}";
                return;
            }
            currentBooking = {
                movieTitle: movieTitle,
                date: date,
                time: time,
                price: 400
            };
            router('booking');
        }

        // --- –õ–û–ì–ò–ö–ê –ë–†–û–ù–ò–†–û–í–ê–ù–ò–Ø ---
        let selectedSeats = [];

        function initBookingPage() {
            document.getElementById('booking-movie-title').innerText = currentBooking.movieTitle;
            document.getElementById('summary-title').innerText = currentBooking.movieTitle;
            document.getElementById('summary-date').innerText = currentBooking.date;
            document.getElementById('summary-time').innerText = currentBooking.time;
            initSeats();
        }

        function initSeats() {
            const grid = document.getElementById('seat-grid');
            if(!grid) return;
            selectedSeats = [];
            
            let seatsHtml = '';
            for (let i = 1; i <= 5; i++) {
                seatsHtml += `<div class="flex gap-2 mb-2"><div class="w-8 h-8 flex items-center justify-center text-xs text-gray-300 mr-2">${i}</div>`;
                for (let j = 1; j <= 8; j++) {
                    const isTaken = Math.random() > 0.8; 
                    const onclick = isTaken ? '' : `onclick="toggleSeat(this, ${i}, ${j})"`;
                    seatsHtml += `<div ${onclick} class="w-8 h-8 rounded-lg transition-all duration-200 ${isTaken ? 'bg-gray-300 cursor-not-allowed' : 'bg-white border border-gray-200 hover:border-brand cursor-pointer hover:shadow-md'}"></div>`;
                }
                seatsHtml += `</div>`;
            }
            grid.innerHTML = seatsHtml;
            updateSummary();
        }

        window.toggleSeat = function(el, r, c) {
            if (el.classList.contains('bg-brand')) {
                el.classList.remove('bg-brand', 'border-brand', 'text-white');
                el.classList.add('bg-white', 'border-gray-200');
                selectedSeats = selectedSeats.filter(s => s.r !== r || s.c !== c);
            } else {
                el.classList.remove('bg-white', 'border-gray-200');
                el.classList.add('bg-brand', 'border-brand', 'text-white');
                selectedSeats.push({r, c});
            }
            updateSummary();
        }

        function updateSummary() {
            const count = selectedSeats.length;
            document.getElementById('total-price').innerText = `${count * currentBooking.price} ‚ÇΩ`;
            
            const textEl = document.getElementById('selected-seats-text');
            if (count === 0) textEl.innerText = "–ù–µ –≤—ã–±—Ä–∞–Ω—ã";
            else {
                selectedSeats.sort((a,b) => (a.r - b.r) || (a.c - b.c));
                textEl.innerText = selectedSeats.map(s => `–†${s.r}–ú${s.c}`).join(', ');
            }
        }

        async function completeBooking() {
            if (!window.USER_IS_AUTH) {
                window.location.href = "{% url 'login' %}?next={% url 'spa' %}";
                return;
            }
            if (selectedSeats.length === 0) {
                alert('–í—ã–±–µ—Ä–∏—Ç–µ —Ö–æ—Ç—è –±—ã –æ–¥–Ω–æ –º–µ—Å—Ç–æ.');
                return;
            }
            
            // –ë–ª–æ–∫–∏—Ä—É–µ–º –∫–Ω–æ–ø–∫—É –≤–æ –≤—Ä–µ–º—è –æ—Ç–ø—Ä–∞–≤–∫–∏
            const btn = document.getElementById('booking-submit-btn');
            if (btn) {
                btn.disabled = true;
                btn.textContent = '–û–±—Ä–∞–±–æ—Ç–∫–∞...';
            }
            
            try {
                const resp = await fetch('/api/booking/', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': getCsrfToken(),
                    },
                    credentials: 'same-origin',
                    body: JSON.stringify({
                        movie_title: currentBooking.movieTitle,
                        seats: selectedSeats,
                    })
                });
                
                if (resp.status === 401) {
                    window.location.href = "{% url 'login' %}?next={% url 'spa' %}";
                    return;
                }
                
                const data = await resp.json();
                
                if (!resp.ok) {
                    const errorMsg = data.detail || data.error || '–ù–µ —É–¥–∞–ª–æ—Å—å —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ';
                    throw new Error(errorMsg);
                }
                
                alert('–ë—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–æ!');
                router('profile');
                loadProfile();
            } catch (e) {
                console.error('Booking error:', e);
                const errorMsg = e.message || '–û—à–∏–±–∫–∞ –ø—Ä–∏ –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–∏. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –µ—â—ë —Ä–∞–∑.';
                alert(errorMsg);
            } finally {
                // –†–∞–∑–±–ª–æ–∫–∏—Ä—É–µ–º –∫–Ω–æ–ø–∫—É
                if (btn) {
                    btn.disabled = false;
                    btn.textContent = '–û–ø–ª–∞—Ç–∏—Ç—å';
                }
            }
        }

        // --- –õ–û–ì–ò–ö–ê –§–ò–õ–¨–ú–û–í (–§–ò–õ–¨–¢–†) ---
        function initFilms(category) {
            const container = document.getElementById('movies-grid');
            const btns = document.getElementById('genre-buttons');
            const genres = ["–í—Å–µ", "–ë–æ–µ–≤–∏–∫", "–ö–æ–º–µ–¥–∏—è", "–î—Ä–∞–º–∞", "–¢—Ä–∏–ª–ª–µ—Ä", "–§–∞–Ω—Ç–∞—Å—Ç–∏–∫–∞"];

            btns.innerHTML = genres.map(g => {
                const active = g === category ? "bg-brand text-white border-brand" : "bg-white text-gray-600 border-gray-200 hover:border-brand";
                return `<button onclick="initFilms('${g}')" class="px-4 py-2 border text-sm rounded-lg transition whitespace-nowrap ${active}">${g}</button>`;
            }).join('');

            const list = category === "–í—Å–µ" ? moviesData : moviesData.filter(m => (m.genre || '').toLowerCase() === category.toLowerCase());
            
            if(list.length === 0) {
                container.innerHTML = `<div class="col-span-4 text-center py-10 text-gray-400">–ù–∏—á–µ–≥–æ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ</div>`;
                return;
            }

            container.innerHTML = list.map(m => {
                const next = getNextSession(m.times);
                return `
                <div class="bg-white rounded-2xl p-4 shadow-sm hover:shadow-lg transition flex flex-col h-full group">
                    <div class="h-64 bg-gray-200 rounded-xl mb-4 relative overflow-hidden flex-shrink-0">
                        <img src="${m.img}" class="w-full h-full object-cover group-hover:scale-105 transition duration-500">
                        <div class="absolute top-2 right-2 bg-white/90 backdrop-blur px-2 py-1 rounded-md text-xs font-bold">‚òÖ ${m.rating}</div>
                    </div>
                    <h3 class="font-bold text-lg mb-1">${m.title} <span class="text-sm font-normal text-gray-500">(${m.genre})</span></h3>
                    <div class="text-xs text-gray-400 mb-4">${m.year} ‚Ä¢ ${m.duration}</div>
                    <button onclick="startBooking('${m.title}', '${next.time}', '${next.date}')" class="mt-auto w-full py-2.5 bg-brand text-white rounded-lg text-sm font-medium hover:bg-brand-hover transition">
                        –ö—É–ø–∏—Ç—å –±–∏–ª–µ—Ç ¬∑ ${next.date}, ${next.time}
                    </button>
                </div>
                `;
            }).join('');
        }

        // --- –õ–û–ì–ò–ö–ê –†–ê–°–ü–ò–°–ê–ù–ò–Ø (–° –§–ò–õ–¨–¢–†–û–ú –ü–û –î–ù–Ø–ú) ---
        function initSchedule(activeDayId = 0) {
            const daysContainer = document.getElementById('schedule-days-container');
            const listContainer = document.getElementById('schedule-list');
            if(!daysContainer) return;

            // 1. –†–µ–Ω–¥–µ—Ä–∏–º –∫–Ω–æ–ø–∫–∏ –¥–Ω–µ–π
            daysContainer.innerHTML = scheduleDays.map(day => {
                const isActive = day.id === activeDayId;
                const buttonClass = isActive 
                    ? "bg-brand text-white shadow-lg shadow-orange-100" 
                    : "bg-white border border-gray-200 text-gray-600 hover:border-brand hover:text-brand";
                
                const labelOpacity = isActive ? "opacity-80" : "opacity-60";

                return `
                    <button onclick="initSchedule(${day.id})" class="flex-shrink-0 px-6 py-3 rounded-xl font-medium transition ${buttonClass}">
                        <div class="text-xs ${labelOpacity}">${day.label}</div>
                        <div class="text-lg font-bold">${day.date}</div>
                    </button>
                `;
            }).join('');

            // 2. –†–µ–Ω–¥–µ—Ä–∏–º —Ñ–∏–ª—å–º—ã —Å —É—á—ë—Ç–æ–º –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç–∏ –ø–æ –≤—Ä–µ–º–µ–Ω–∏ (–ú–°–ö)
            const selectedDateString = scheduleDays.find(d => d.id === activeDayId).date;
            const baseDate = getMoscowDate(activeDayId);
            const nowMsk = getMoscowDate(0);

            listContainer.innerHTML = moviesData.map(m => {
                const times = m.times.map(t => {
                    let [h, min] = t.split(':').map(Number);
                    const candidate = new Date(baseDate);
                    candidate.setHours(h, min, 0, 0);
                    const isPast = candidate <= nowMsk && baseDate.toDateString() === nowMsk.toDateString();
                    return { time: `${String(h).padStart(2,'0')}:${String(min).padStart(2,'0')}`, available: !isPast };
                });

                return `
                    <div class="bg-white rounded-2xl p-6 shadow-sm border border-gray-100 flex flex-col md:flex-row gap-6 animate-fade">
                        <div class="w-full md:w-32 h-48 md:h-32 rounded-xl overflow-hidden flex-shrink-0 relative">
                             <img src="${m.img}" class="w-full h-full object-cover">
                        </div>
                        <div class="flex-grow">
                            <div class="flex justify-between items-start mb-2">
                                <div>
                                    <h3 class="text-xl font-bold text-gray-900">${m.title} <span class="text-base font-normal text-gray-500">(${m.genre})</span></h3>
                                    <p class="text-sm text-gray-400">${m.duration} ‚Ä¢ ${m.year}</p>
                                </div>
                                <div class="bg-orange-50 text-brand px-2 py-1 rounded text-sm font-bold">‚òÖ ${m.rating}</div>
                            </div>
                            
                            <div class="mt-6">
                                <p class="text-xs font-semibold text-gray-400 uppercase mb-3">–°–µ–∞–Ω—Å—ã –Ω–∞ ${selectedDateString}</p>
                                <div class="flex flex-wrap gap-3">
                                    ${times.map(tt => tt.available
                                        ? `<button onclick="startBooking('${m.title}', '${tt.time}', '${selectedDateString}')" 
                                                class="px-5 py-2 border border-gray-200 rounded-lg text-sm font-medium hover:bg-brand hover:text-white hover:border-brand transition">
                                            ${tt.time}
                                        </button>`
                                        : `<span class="px-5 py-2 border border-gray-100 rounded-lg text-sm text-gray-400 bg-gray-50 cursor-not-allowed">
                                            ${tt.time} (–Ω–µ–¥–æ—Å—Ç—É–ø–Ω–æ)
                                        </span>`
                                    ).join('')}
                                </div>
                            </div>
                        </div>
                    </div>
                `;
            }).join('');
        }

        // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –≤—Ä–µ–º–µ–Ω–∏ –Ω–∞ —Å–∞–π—Ç–µ
        function updateTime() {
            const timeEl = document.getElementById('current-time');
            if (timeEl) {
                const now = new Date();
                const mskString = now.toLocaleString('ru-RU', { 
                    timeZone: 'Europe/Moscow',
                    hour: '2-digit',
                    minute: '2-digit',
                    second: '2-digit'
                });
                timeEl.textContent = mskString;
            }
        }
        
        // –û–±–Ω–æ–≤–ª—è–µ–º –≤—Ä–µ–º—è –∫–∞–∂–¥—É—é —Å–µ–∫—É–Ω–¥—É
        setInterval(updateTime, 1000);
        updateTime(); // –ü–µ—Ä–≤—ã–π –≤—ã–∑–æ–≤ —Å—Ä–∞–∑—É

        // –ó–∞–ø—É—Å–∫
        const params = new URLSearchParams(window.location.search);
        const initialRoute = params.get('route') || 'home';
        router(initialRoute);

    </script>
</body>
</html>
</html>